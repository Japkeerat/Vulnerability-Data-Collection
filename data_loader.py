import logging
from multiprocessing import Queue

import pandas as pd


class NVDDataLoader:
    def __init__(self, loading_queue: Queue, transformation_completion_flag: bool):
        self.loading_queue = loading_queue
        self.transformation_completion_flag = transformation_completion_flag
        self.list_of_records = list()

    def prepare_data(self, data: tuple):
        self.list_of_records.append(data)

    def load_data(self):
        logging.info("Starting the loading process")
        while not self.transformation_completion_flag or not self.loading_queue.empty():
            logging.info("Currently loading Data")
            try:
                data = self.loading_queue.get(timeout=1000)
                self.prepare_data(data)
            except:
                break
        df = pd.DataFrame(
            self.list_of_records, columns=["cve_id", "cwe_id", "cpe_id", "description", "status", "created_at", "modified_at"]
        )
        df.to_csv("data/cve_data.csv", index=False)
        logging.info("Data Loaded to CSV file")
